## **数独乐乐：软件配置与运维文档**

### **1. 文档概述**

本文档旨在为"数独乐乐"项目的开发人员和运维人员提供全面的技术指南。内容涵盖了从开发环境配置、版本控制策略、自动化构建与部署，到最终的线上运维计划，旨在确保项目的开发流程标准化、部署过程自动化以及线上服务稳定可靠。

### **2. 配置管理**

项目的配置管理旨在确保开发、测试和生产环境的一致性与可复现性。

* **环境依赖**:
    * **Node.js**: 项目需要 Node.js 的长期支持（LTS）版本。具体的版本要求和安装指南参见 `README.md` 文件。
    * **依赖包**: 所有项目依赖（包括开发依赖和生产依赖）均在 `package.json` 文件中进行统一声明。通过 `npm install` 命令即可一键安装所有必需的模块，`package-lock.json` 文件则确保了所有开发者和 CI/CD 环境使用的依赖版本完全一致。

* **构建与打包配置**:
    * 项目使用 **Rollup** 作为模块打包器。其配置文件 `rollup.config.js` 定义了完整的构建流程，包括：
        * **入口文件**: `src/main.js`。
        * **输出配置**: 生成的文件位于 `dist/bundle.js`，在非生产环境下会包含 sourcemap。
        * **静态资源处理**: 使用 `rollup-plugin-copy` 复制 `src/template.html` 到 `dist/index.html`，以及复制 `static` 目录下所有文件到 `dist` 目录。
        * **Svelte 预处理**: 使用 `svelte-preprocess` 支持 PostCSS、Tailwind CSS 等现代 CSS 特性。
        * **CSS 处理**: 在生产模式下，关键 CSS 会被提取到 `critical.css` 文件中，用于后续内联到 HTML 中。
        * **生产环境优化**: 在生产模式 (`production`) 下，会自动启用 `terser` 进行代码压缩和混淆，并使用 `postcss-clean` 优化 CSS。
    * **构建脚本流程**:
        * `prebuild`: 使用 `rimraf` 清空 `dist` 目录
        * `build`: 使用 Rollup 执行生产环境构建
        * `postbuild`: 执行 `scripts/postbuild.js` 脚本，将关键 CSS 内联到 HTML，并为 JS 文件添加哈希值
    * 开发服务器通过 `sirv dist` 命令启动，提供热重载（livereload）功能以提升开发效率。

* **测试配置**:
    * 项目使用 **Jest** 作为测试框架。配置文件 `jest.config.js` 定义了测试环境、文件匹配规则和代码覆盖率目标。
    * Svelte 组件的转换由 `svelte-jester` 处理，而普通 JavaScript 文件则通过 `babel-jest` 进行转换。
    * 测试文件需放置在 `__tests__` 目录下，并以 `.test.js` 或 `.test.ts` 作为后缀。
    * 代码覆盖率的最低阈值被设定为70%，确保了代码质量有基本的保障。
    * 支持三种测试命令：
        * `npm test`: 运行所有测试
        * `npm run test:watch`: 监视模式，在代码变更时自动重新运行测试
        * `npm run test:coverage`: 生成代码覆盖率报告


### **3. 版本控制**

项目使用 Git 进行版本控制，并托管在 GitHub 上。

* **分支策略**:
    * `main`: 主分支，代表了稳定且可随时部署的生产代码。只接受来自 `pull_request` 的合并，不允许直接提交。
    * **功能分支 (Feature Branches)**: 所有新功能的开发和 Bug 修复都应在单独的功能分支上进行。分支命名建议采用 `feat/功能描述` 或 `fix/问题描述` 的格式。
    * **Pull Request (PR)**: 功能开发完成后，开发者需创建 Pull Request 到 `main` 分支。PR 需要经过代码审查（Code Review）和所有自动化检查通过后，方可合并。

* **提交信息规范**:
    * 建议遵循 **Conventional Commits** 规范，以提高提交历史的可读性并为自动化工具提供支持。格式为：`type(scope): description`。
        * **`feat`**: 新功能
        * **`fix`**: Bug 修复
        * **`docs`**: 文档变更
        * **`style`**: 代码格式（不影响代码运行的变动）
        * **`refactor`**: 重构（既不是新增功能，也不是修改bug的代码变动）
        * **`test`**: 增加测试
        * **`chore`**: 构建过程或辅助工具的变动


### **4. 持续集成**

项目利用 GitHub Actions 实现持续集成，旨在自动化代码质量检查和构建流程。

* **CodeQL 安全分析**:
    * **触发条件**: 当有代码推送到 `main` 分支或创建指向 `main` 分支的 Pull Request 时自动触发。
    * **流程**: `codeql-analysis.yml` 文件定义了该工作流。它会初始化 CodeQL 环境，扫描 JavaScript 代码中的潜在安全漏洞和常见错误，并将结果报告在 GitHub Security 标签页中。
    * **目标**: 确保及早发现并修复代码中的安全问题，提升代码质量。

* **自动化测试**:
    * 在 CI 流程中加入 `npm test` 命令，以自动运行所有单元测试和集成测试。
    * 测试报告会在 GitHub Actions 界面中展示，并作为 PR 合并的必要条件。
    * 代码覆盖率报告会在测试完成后生成，并通过 GitHub Actions 存档。
    * 只有当所有测试用例通过且代码覆盖率达到预设阈值时，PR 才被允许合并。

* **依赖安全扫描**:
    * 集成 GitHub Dependabot，定期（每月一次）扫描依赖包中的安全漏洞。
    * 当发现安全问题时，Dependabot 会自动创建 PR 以更新受影响的依赖包。


### **5. 部署**

项目采用持续部署（CD）策略，通过 GitHub Actions 自动将 `main` 分支的最新代码部署到 GitHub Pages。

* **部署工作流**:
    * **触发条件**: 当有代码成功推送到 `main` 分支时触发。
    * **流程**: 部署工作流定义了完整的部署过程：
        1.  **Checkout**: 签出最新的代码。
        2.  **Setup & Install**: 设置 Node.js 环境并安装所有项目依赖。
        3.  **Build**: 运行 `npm run build` 命令，生成用于生产环境的静态文件到 `dist` 目录。
        4.  **Post-build**: 构建后，`scripts/postbuild.js` 脚本会自动执行，它会：
            * 读取 `src/template.html` 和 `dist/critical.css` 文件
            * 使用 `inline-critical` 库将关键 CSS 内联到 HTML 中
            * 为 JavaScript bundle 文件名添加哈希值（使用 `reaver` 库计算文件哈希）
            * 替换 HTML 中的 JS 引用为带哈希值的文件名
            * 删除冗余的 CSS 文件（`critical.css` 和 `bundle.css`）
            * 将处理后的 HTML 写入 `dist/index.html`
        5.  **Deploy**: 将 `dist` 目录的内容推送到项目的部署分支，完成网站部署。

* **缓存策略**:
    * JS 和 CSS 文件名包含基于内容生成的哈希值，实现长期缓存策略。
    * 关键 CSS 内联到 HTML 中，减少首屏加载时的请求数量，提高性能。

* **回滚机制**:
    * 如发现部署后的问题，可以通过 GitHub 界面快速回滚到上一个稳定的提交。
    * 回滚操作将自动触发新的部署工作流，恢复到之前的稳定版本。


### **6. 运维计划**

* **监控与告警**:
    * **可用性监控**: 使用第三方服务（如 UptimeRobot, Pingdom）对生产站点进行定期 HTTP 检查。一旦网站无法访问，应立即通过邮件或即时消息通知核心开发人员。
    * **前端异常监控**: 集成前端监控平台（如 Sentry, LogRocket），以捕获用户在实际使用中遇到的 JavaScript 错误和性能问题。这对于快速定位和修复生产环境的 Bug 至关重要。
    * **性能监控**: 定期使用 Lighthouse 或 WebPageTest 等工具检查页面性能，确保用户体验持续优化。

* **日志管理**:
    * 当前项目主要在客户端运行，不产生服务端日志。所有错误日志都应通过前端异常监控平台进行收集和分析。
    * 在关键操作处添加自定义事件记录，以便更好地了解用户行为和潜在问题。

* **备份与恢复**:
    * **代码备份**: 所有代码均托管在 GitHub 上，GitHub 本身提供了高可用的版本控制服务，作为代码的天然备份。
    * **服务恢复**: 由于应用是纯静态部署在 GitHub Pages 上，服务本身是高可用的。如果出现部署问题，最快的恢复方式是通过 Git 将 `main` 分支回滚到上一个稳定版本，GitHub Actions 会自动触发新的部署流程来完成恢复。

* **安全与维护**:
    * **依赖更新**: 定期（每月一次）使用 `npm outdated` 命令检查过时的依赖包，并使用 `npm update` 进行更新。对于重大版本更新，需要在本地充分测试后再提交。使用 GitHub 的 Dependabot 来自动化这个过程。
    * **安全审计**: 定期审查 CodeQL 的扫描报告，并及时修复发现的任何安全漏洞。
    * **性能优化**: 每季度进行一次全面的性能审核，检查资源加载时间、首屏渲染时间和交互响应时间，必要时进行优化。
    * **兼容性测试**: 定期在不同浏览器和设备上测试应用，确保跨平台兼容性。

* **用户支持与反馈**:
    * 设置专用的问题反馈渠道（如 GitHub Issues），允许用户报告问题或提出功能请求。
    * 定期分析用户反馈，将常见问题和解决方案整理成 FAQ，并在 README 中更新。